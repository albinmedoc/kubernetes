apiVersion: v1
kind: ConfigMap
metadata:
  name: config
  namespace: traefik
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/managed-by: kubectl
data:
  traefik.yaml: |
    global:
      checkNewVersion: false
      sendAnonymousUsage: false

    ping: true

    entryPoints:
      web:
        address: ":80"
        http:
          redirections:
            entrypoint:
              to: websecure
              scheme: https
              permanent: true
      websecure:
        address: ":443"
        http:
          tls:
            certResolver: letsencrypt-dns
      minecraft:
        address: ":25565"

    api:
      insecure: true

    metrics:
      prometheus:
        entryPoint: traefik

    providers:
      kubernetescrd:
        allowCrossNamespace: true
      file:
        filename: /config/file-provider.yaml

    certificatesResolvers:
      letsencrypt-dns:
        acme:
          dnsChallenge:
            provider: cloudflare
            delayBeforeCheck: 10
          email: kontakt@albinmedoc.se
          storage: /certs/acme-dns.json
  file-provider.yaml: |
    http:
      routers:
        default-catch-all:
          rule: "HostRegexp(`{host:.+}`)"
          service: noop
          entrypoints: websecure
          priority: 1
        plex:
          rule: "Host(`flexflix.top`)"
          service: plex
          entrypoints: websecure
        truenas:
          rule: "Host(`truenas.albinmedoc.se`)"
          service: truenas
          entrypoints: websecure
          middlewares:
            - traefik-local-network@kubernetescrd
        proxmox:
          rule: "Host(`proxmox.albinmedoc.se`)"
          service: proxmox
          entrypoints: websecure
          middlewares:
            - traefik-local-network@kubernetescrd
        adguard:
          rule: "Host(`adguard.albinmedoc.se`)"
          service: adguard
          entrypoints: websecure
          middlewares:
            - traefik-local-network@kubernetescrd
            - authentik-authentik@kubernetescrd
        immich:
          rule: "Host(`immich.albinmedoc.se`)"
          service: immich
          entrypoints: websecure

      services:
        noop:
          loadBalancer:
            servers:
              - url: "http://127.0.0.1:9999"
        plex:
          loadBalancer:
            servers:
              - url: "http://192.168.86.122:32400"
        truenas:
          loadBalancer:
            servers:
              - url: "http://192.168.86.109"
        proxmox:
          loadBalancer:
            serversTransport: proxmox
            servers:
              - url: "https://192.168.86.106:8006"
        adguard:
          loadBalancer:
            servers:
              - url: "http://192.168.86.238"
        immich:
          loadBalancer:
            servers:
              - url: "http://192.168.86.109:30041"

      serversTransports:
        proxmox:
          insecureSkipVerify: true
    tcp:
      routers:
        minecraft:
          rule: "HostSNI(`*`)"
          service: minecraft-router
          entryPoints:
            - minecraft
      services:
        minecraft-router:
          loadBalancer:
            servers:
              - address: "minecraft-router.minecraft-router.svc.cluster.local:25565"